var filechooser=document.getElementById("choose");var canvas=document.createElement("canvas");var ctx=canvas.getContext("2d");var tCanvas=document.createElement("canvas");var tctx=tCanvas.getContext("2d");var maxsize=100*1024;$("#upload").on("click",function(){filechooser.click()}).on("touchstart",function(){$(this).addClass("touch")}).on("touchend",function(){$(this).removeClass("touch")});filechooser.onchange=function(){$(".img-list-2").css({border:"none"});$(".fa-picture").hide();$(".img-list li").remove();if(!this.files.length){$(".fa-picture").show();return}var files=Array.prototype.slice.call(this.files);files.forEach(function(file,i){console.log(files.length);if(!/\/(?:jpeg|png|gif)/i.test(file.type)){return}var reader=new FileReader();var li=document.createElement("li");var size=file.size/1024>1024?(~~(10*file.size/1024/1024))/10+"MB":~~(file.size/1024)+"KB";$(".img-list").append($(li));reader.onload=function(){var result=this.result;var img=new Image();img.src=result;$(li).css("background-image","url("+result+")");if(result.length<=maxsize){img=null;upload(result,file.type,$(li));return}if(img.complete){callback()}else{img.onload=callback}function callback(){var data=compress(img);upload(data,file.type,$(li));img=null}};reader.readAsDataURL(file)})};function compress(img){var initSize=img.src.length;var width=img.width;var height=img.height;var ratio;if((ratio=width*height/4000000)>1){ratio=Math.sqrt(ratio);width/=ratio;height/=ratio}else{ratio=1}canvas.width=width;canvas.height=height;ctx.fillStyle="#fff";ctx.fillRect(0,0,canvas.width,canvas.height);var count;if((count=width*height/1000000)>1){count=~~(Math.sqrt(count)+1);var nw=~~(width/count);var nh=~~(height/count);tCanvas.width=nw;tCanvas.height=nh;for(var i=0;i<count;i++){for(var j=0;j<count;j++){tctx.drawImage(img,i*nw*ratio,j*nh*ratio,nw*ratio,nh*ratio,0,0,nw,nh);ctx.drawImage(tCanvas,i*nw,j*nh,nw,nh)}}}else{ctx.drawImage(img,0,0,width,height)}var ndata=canvas.toDataURL("image/jpeg",0.1);console.log("压缩前："+initSize);console.log("压缩后："+ndata.length);console.log("压缩率："+~~(100*(initSize-ndata.length)/initSize)+"%");tCanvas.width=tCanvas.height=canvas.width=canvas.height=0;return ndata}function upload(basestr,type,$li){var text=window.atob(basestr.split(",")[1]);var buffer=new Uint8Array(text.length);var pecent=0,loop=null;for(var i=0;i<text.length;i++){buffer[i]=text.charCodeAt(i)}var blob=getBlob([buffer],type);var xhr=new XMLHttpRequest();var formdata=getFormData();formdata.append("imagefile",blob);xhr.open("post","/party/user/headshot/save");xhr.onreadystatechange=function(){if(xhr.readyState==4&&xhr.status==200){var jsonData=JSON.parse(xhr.responseText);var imagedata=jsonData[0]||{};var text=imagedata.path?"上传成功":"上传失败";console.log(text+"："+imagedata.path);clearInterval(loop);$li.find(".progress span").animate({"width":"100%"},pecent<95?200:0,function(){$(this).html(text)});if(!imagedata.path){return}$(".pic-list").append('<a href="'+imagedata.path+'">'+imagedata.name+"（"+imagedata.size+'）<img th:src="'+imagedata.path+'" /></a>')}};xhr.upload.addEventListener("progress",function(e){if(loop){return}pecent=~~(100*e.loaded/e.total)/2;$li.find(".progress span").css("width",pecent+"%");if(pecent==50){mockProgress()}},false);function mockProgress(){if(loop){return}loop=setInterval(function(){pecent++;$li.find(".progress span").css("width",pecent+"%");if(pecent==99){clearInterval(loop)}},100)}}function getBlob(buffer,format){try{return new Blob(buffer,{type:format})}catch(e){var bb=new (window.BlobBuilder||window.WebKitBlobBuilder||window.MSBlobBuilder);buffer.forEach(function(buf){bb.append(buf)});return bb.getBlob(format)}}function getFormData(){var isNeedShim=~navigator.userAgent.indexOf("Android")&&~navigator.vendor.indexOf("Google")&&!~navigator.userAgent.indexOf("Chrome")&&navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop()<=534;return isNeedShim?new FormDataShim():new FormData()}function FormDataShim(){console.warn("using formdata shim");var o=this,parts=[],boundary=Array(21).join("-")+(+new Date()*(10000000000000000*Math.random())).toString(36),oldSend=XMLHttpRequest.prototype.send;this.append=function(name,value,filename){parts.push("--"+boundary+'\r\nContent-Disposition: form-data; name="'+name+'"');if(value instanceof Blob){parts.push('; filename="'+(filename||"blob")+'"\r\nContent-Type: '+value.type+"\r\n\r\n");parts.push(value)}else{parts.push("\r\n\r\n"+value)}parts.push("\r\n")}};